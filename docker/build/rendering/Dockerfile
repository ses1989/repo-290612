# escape=`

#
# Image for running Next.js in a containerized environment.
#

ARG NODEJS_IMAGE
FROM ${NODEJS_IMAGE} as debug

SHELL ["pwsh.exe", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# This stage is used for development purposes.
# Assumes that the JSS source code is mounted to C:\app.
WORKDIR C:\app

EXPOSE 3000
ENTRYPOINT "npm run start:connected"

FROM debug as release

# This stage is used for CI purposes.
# Copy local app (results of 'jss create')
# First copy is a build optimization. If there are no changes in package.json or package-lock.json
# then the cache will be used for the layer generated by the RUN npm ci instruction.
COPY .\app\package.json .\app\package-lock.json .\
RUN npm ci
COPY .\app .\